<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Resources depending on an authenticated user | The REST API cookbook</title>
    <meta name="generator" content="VuePress 1.8.2">
    
    <meta name="description" content="Should I expose resources depending on the user authenticated by an access token?">
    
    <link rel="preload" href="/cookbook/assets/css/0.styles.61efb392.css" as="style"><link rel="preload" href="/cookbook/assets/js/app.622da551.js" as="script"><link rel="preload" href="/cookbook/assets/js/3.9f6d8892.js" as="script"><link rel="preload" href="/cookbook/assets/js/1.58ef23db.js" as="script"><link rel="preload" href="/cookbook/assets/js/21.7d79eb9d.js" as="script"><link rel="prefetch" href="/cookbook/assets/js/10.23a6cb12.js"><link rel="prefetch" href="/cookbook/assets/js/11.9041e3c5.js"><link rel="prefetch" href="/cookbook/assets/js/12.52c41b56.js"><link rel="prefetch" href="/cookbook/assets/js/13.9bf64610.js"><link rel="prefetch" href="/cookbook/assets/js/14.45cb85e4.js"><link rel="prefetch" href="/cookbook/assets/js/15.6171fe55.js"><link rel="prefetch" href="/cookbook/assets/js/16.7f6e22f5.js"><link rel="prefetch" href="/cookbook/assets/js/17.41eeb92c.js"><link rel="prefetch" href="/cookbook/assets/js/18.86f1b7b2.js"><link rel="prefetch" href="/cookbook/assets/js/19.2826aac8.js"><link rel="prefetch" href="/cookbook/assets/js/20.b9c3470d.js"><link rel="prefetch" href="/cookbook/assets/js/22.ccb5379d.js"><link rel="prefetch" href="/cookbook/assets/js/4.f8125ee1.js"><link rel="prefetch" href="/cookbook/assets/js/5.d45ab0d5.js"><link rel="prefetch" href="/cookbook/assets/js/6.b29b864a.js"><link rel="prefetch" href="/cookbook/assets/js/7.6dafa1e9.js"><link rel="prefetch" href="/cookbook/assets/js/8.1b37a035.js"><link rel="prefetch" href="/cookbook/assets/js/9.2139fb15.js">
    <link rel="stylesheet" href="/cookbook/assets/css/0.styles.61efb392.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container no-sidebar"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/cookbook/" class="home-link router-link-active"><!----> <span class="site-name">The REST API cookbook</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <!----></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><!---->  <!----> </aside> <main class="page"> <div class="theme-default-content content__default"><h1 id="resources-depending-on-an-authenticated-user"><a href="#resources-depending-on-an-authenticated-user" class="header-anchor">#</a> Resources depending on an authenticated user</h1> <h2 id="use-case"><a href="#use-case" class="header-anchor">#</a> Use-case</h2> <p>I expect my API to be called with an already authenticated user (usually by an OAuth2 access token). This happens when the Client is a frontend or any other backend service.</p> <p>I want to retrieve data linked to the user, for example:</p> <ul><li>user profile</li> <li>list of user orders</li> <li>etc.</li></ul> <p>How can I do that?
Should I expose a simple <code>GET /profile</code> endpoint, that will use the access token to identify the user and retrieve its profile?</p> <h2 id="recipe"><a href="#recipe" class="header-anchor">#</a> Recipe</h2> <p>Let's start with a <em>don't</em>:</p> <blockquote><p>using the access token as an implicit parameter of a regular endpoint is <strong>not</strong> a good idea.</p></blockquote> <p>Let's assume we have this <code>GET /profile</code> endpoint.
It has no parameters, other than the access token expected in the <code>Authorization</code> header.</p> <p>The backend will extract the user id from the access token, and use it as the parameter of the endpoint.</p> <p>Given an access token belonging to Alice:</p> <div class="language-shell extra-class"><pre class="language-shell"><code><span class="token function">curl</span> <span class="token punctuation">\</span>
-H <span class="token string">&quot;Authorization: Bearer &lt;alice_access_token&gt;&quot;</span> <span class="token punctuation">\</span>
https://api.example.com/v1/profile
</code></pre></div><div class="language-json extra-class"><pre class="language-json"><code><span class="token punctuation">{</span>
  <span class="token property">&quot;username&quot;</span><span class="token operator">:</span> <span class="token string">&quot;Alice&quot;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>Same call with an access token belonging to Bob:</p> <div class="language-shell extra-class"><pre class="language-shell"><code><span class="token function">curl</span> <span class="token punctuation">\</span>
-H <span class="token string">&quot;Authorization: Bearer &lt;bob_access_token&gt;&quot;</span> <span class="token punctuation">\</span>
https://api.example.com/v1/profile
</code></pre></div><div class="language-json extra-class"><pre class="language-json"><code><span class="token punctuation">{</span>
  <span class="token property">&quot;username&quot;</span><span class="token operator">:</span> <span class="token string">&quot;Bob&quot;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>Seems pretty convenient, right? But what's wrong with this design?</p> <p><strong>Flaw 1:</strong> Here comes a new need: in addition to the frontend, where the user is logged, an administrator should be allowed to access all user profiles.</p> <p><em>Can't do:</em> you coupled your API endpoint with the ACL to be applied on the resource. An admin may comes with its own access token, but it will only contains its own id. It has no way to pass the required user id as a parameter.<br>
You would have to create a specific endpoint for the admin use case. It would be a shame, since being reusable for different clients is what APIs are all about.</p> <p><strong>Flaw 2:</strong> To improve my API performances, I would like to add some cache on top of it, for example using a CDN and the proper cache-control headers.</p> <p><em>Can't do:</em> All the user profiles are retrieved under the same request, except for the access token. The cache service will not be able to distinguish them (unless you store the access token itself in the cache key, but you certainly don't want to do that!)</p> <p><strong>Flaw 3:</strong> This design is not affordant for a developer used to a classic REST design.<br>
Looking at the <code>GET /profile</code> resource, I expect the response to be always the same, as there is no clue indicating that the response depends on the access token. I would have to go through the doc to understand that.</p> <p>Having these limits in mind, what can we do?</p> <h3 id="option-1-require-explicit-business-parameters"><a href="#option-1-require-explicit-business-parameters" class="header-anchor">#</a> Option 1: require explicit business parameters</h3> <p>All the previous flaws are caused because the <code>user id</code> is passed through the access token, even though it is a business parameter (the response content depends on it).</p> <p>The simplest solution is to explicitly require all your business parameters, like for any other resource:<br>
For example, using <code>GET /profiles/:userId</code></p> <div class="language-shell extra-class"><pre class="language-shell"><code><span class="token function">curl</span> <span class="token punctuation">\</span>
-H <span class="token string">&quot;Authorization: Bearer &lt;alice_access_token&gt;&quot;</span> <span class="token punctuation">\</span>
https://api.example.com/v1/profiles/12345
</code></pre></div><div class="language-json extra-class"><pre class="language-json"><code><span class="token punctuation">{</span>
  <span class="token property">&quot;id&quot;</span><span class="token operator">:</span> <span class="token number">12345</span><span class="token punctuation">,</span>
  <span class="token property">&quot;username&quot;</span><span class="token operator">:</span> <span class="token string">&quot;Alice&quot;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>So that you separate concerns:</p> <ul><li>when the response of your endpoint depends on business parameters, they are explicitly requested in path parameters, query string or request body.</li> <li>when the right to access to your resource depends on the ACL of the user, they are enforced using the access token.</li></ul> <p>Constraints:</p> <ul><li>for the API Client: extract the user id from the access token or the id token (generally in the <code>sub</code> claim). But in most contexts, user id should be an information already known by the frontend.</li> <li>for the API: we now have to check that the authenticated user can access the requested operation (as it was implicit with the previous design)</li></ul> <h3 id="option-2-show-explicitly-that-the-access-token-is-used-as-a-parameter"><a href="#option-2-show-explicitly-that-the-access-token-is-used-as-a-parameter" class="header-anchor">#</a> Option 2: show explicitly that the access token is used as a parameter</h3> <p>You may think that your API design is dedicated to a single frontend use, and not be afraid by the previous flaws.</p> <p>In this case, it can makes sense to favour a flawless usage for your frontend, and offer a simpler way to access some of the authenticated user information.</p> <p>But if you want do go this way, we strongly suggest to <strong>make it explicit in the endpoint naming</strong>, to avoid at least the non-affordance flaw.</p> <p>A common way to expose such an endpoint is to use <code>/me</code> or <code>/@me</code> in the endpoint. A developer will be able to understand that this endpoint is about the authenticated user:</p> <ul><li><code>GET /profile/@me</code></li> <li><code>GET /users/@me/profile</code></li> <li><code>GET /@me</code> as a shortcut for the user profile</li> <li><code>GET /@me/orders</code> for the orders of the authenticated user</li> <li>...</li></ul> <p>An example <a href="https://developer.spotify.com/documentation/web-api/reference/#category-library" target="_blank" rel="noopener noreferrer">on Spotify API<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>:<br> <code>GET https://api.spotify.com/v1/me/albums</code> : get the albums of the authenticated user.</p> <p>Here is a request with Alice access token, retrieving Alice's profile:</p> <div class="language-shell extra-class"><pre class="language-shell"><code><span class="token function">curl</span> <span class="token punctuation">\</span>
-H <span class="token string">&quot;Authorization: Bearer &lt;alice_access_token&gt;&quot;</span> <span class="token punctuation">\</span>
https://api.example.com/v1/profile/@me
</code></pre></div><div class="language-json extra-class"><pre class="language-json"><code><span class="token punctuation">{</span>
  <span class="token property">&quot;id&quot;</span><span class="token operator">:</span> <span class="token number">12345</span><span class="token punctuation">,</span>
  <span class="token property">&quot;username&quot;</span><span class="token operator">:</span> <span class="token string">&quot;Alice&quot;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>Here is a request with Bob access token, retrieving Bob's profile:</p> <div class="language-shell extra-class"><pre class="language-shell"><code><span class="token function">curl</span> <span class="token punctuation">\</span>
-H <span class="token string">&quot;Authorization: Bearer &lt;bob_access_token&gt;&quot;</span> <span class="token punctuation">\</span>
https://api.example.com/v1/profile/@me
</code></pre></div><div class="language-json extra-class"><pre class="language-json"><code><span class="token punctuation">{</span>
  <span class="token property">&quot;id&quot;</span><span class="token operator">:</span> <span class="token number">67890</span><span class="token punctuation">,</span>
  <span class="token property">&quot;username&quot;</span><span class="token operator">:</span> <span class="token string">&quot;Bob&quot;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>In a nutshell:</p> <ul><li>This may be a legitimate use case if your API is dedicated to a frontend.</li> <li>Be aware that this design jeopardize the reuse of your API, and forbid any caching feature.</li> <li>This should be limited to a few simple endpoints: having this design on your complete API would be a huge smell!</li></ul></div> <footer class="page-edit"><!----> <!----></footer> <!----> </main></div><div class="global-ui"></div></div>
    <script src="/cookbook/assets/js/app.622da551.js" defer></script><script src="/cookbook/assets/js/3.9f6d8892.js" defer></script><script src="/cookbook/assets/js/1.58ef23db.js" defer></script><script src="/cookbook/assets/js/21.7d79eb9d.js" defer></script>
  </body>
</html>
