(window.webpackJsonp=window.webpackJsonp||[]).push([[16],{394:function(e,t,s){"use strict";s.r(t);var a=s(42),n=Object(a.a)({},(function(){var e=this,t=e.$createElement,s=e._self._c||t;return s("ContentSlotsDistributor",{attrs:{"slot-key":e.$parent.slotKey}},[s("h1",{attrs:{id:"resources-depending-on-an-authenticated-user"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#resources-depending-on-an-authenticated-user"}},[e._v("#")]),e._v(" Resources depending on an authenticated user")]),e._v(" "),s("h2",{attrs:{id:"use-case"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#use-case"}},[e._v("#")]),e._v(" Use-case")]),e._v(" "),s("p",[e._v("I expect my API to be called with an already authenticated user (usually by an OAuth2 access token). This happens when the Client is a frontend or any other backend service.")]),e._v(" "),s("p",[e._v("I want to retrieve data linked to the user, for example:")]),e._v(" "),s("ul",[s("li",[e._v("user profile")]),e._v(" "),s("li",[e._v("list of user orders")]),e._v(" "),s("li",[e._v("etc.")])]),e._v(" "),s("p",[e._v("How can I do that?\nShould I expose a simple "),s("code",[e._v("GET /profile")]),e._v(" endpoint, that will use the access token to identify the user and retrieve its profile?")]),e._v(" "),s("h2",{attrs:{id:"recipe"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#recipe"}},[e._v("#")]),e._v(" Recipe")]),e._v(" "),s("p",[e._v("Let's start with a "),s("em",[e._v("don't")]),e._v(":")]),e._v(" "),s("blockquote",[s("p",[e._v("using the access token as an implicit parameter of a regular endpoint is "),s("strong",[e._v("not")]),e._v(" a good idea.")])]),e._v(" "),s("p",[e._v("Let's assume we have this "),s("code",[e._v("GET /profile")]),e._v(" endpoint.\nIt has no parameters, other than the access token expected in the "),s("code",[e._v("Authorization")]),e._v(" header.")]),e._v(" "),s("p",[e._v("The backend will extract the user id from the access token, and use it as the parameter of the endpoint.")]),e._v(" "),s("p",[e._v("Given an access token belonging to Alice:")]),e._v(" "),s("div",{staticClass:"language-shell extra-class"},[s("pre",{pre:!0,attrs:{class:"language-shell"}},[s("code",[s("span",{pre:!0,attrs:{class:"token function"}},[e._v("curl")]),e._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("\\")]),e._v("\n-H "),s("span",{pre:!0,attrs:{class:"token string"}},[e._v('"Authorization: Bearer <alice_access_token>"')]),e._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("\\")]),e._v("\nhttps://api.example.com/v1/profile\n")])])]),s("div",{staticClass:"language-json extra-class"},[s("pre",{pre:!0,attrs:{class:"language-json"}},[s("code",[s("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("{")]),e._v("\n  "),s("span",{pre:!0,attrs:{class:"token property"}},[e._v('"username"')]),s("span",{pre:!0,attrs:{class:"token operator"}},[e._v(":")]),e._v(" "),s("span",{pre:!0,attrs:{class:"token string"}},[e._v('"Alice"')]),e._v("\n"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("}")]),e._v("\n")])])]),s("p",[e._v("Same call with an access token belonging to Bob:")]),e._v(" "),s("div",{staticClass:"language-shell extra-class"},[s("pre",{pre:!0,attrs:{class:"language-shell"}},[s("code",[s("span",{pre:!0,attrs:{class:"token function"}},[e._v("curl")]),e._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("\\")]),e._v("\n-H "),s("span",{pre:!0,attrs:{class:"token string"}},[e._v('"Authorization: Bearer <bob_access_token>"')]),e._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("\\")]),e._v("\nhttps://api.example.com/v1/profile\n")])])]),s("div",{staticClass:"language-json extra-class"},[s("pre",{pre:!0,attrs:{class:"language-json"}},[s("code",[s("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("{")]),e._v("\n  "),s("span",{pre:!0,attrs:{class:"token property"}},[e._v('"username"')]),s("span",{pre:!0,attrs:{class:"token operator"}},[e._v(":")]),e._v(" "),s("span",{pre:!0,attrs:{class:"token string"}},[e._v('"Bob"')]),e._v("\n"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("}")]),e._v("\n")])])]),s("p",[e._v("Seems pretty convenient, right? But what's wrong with this design?")]),e._v(" "),s("p",[s("strong",[e._v("Flaw 1:")]),e._v(" Here comes a new need: in addition to the frontend, where the user is logged, an administrator should be allowed to access all user profiles.")]),e._v(" "),s("p",[s("em",[e._v("Can't do:")]),e._v(" you coupled your API endpoint with the ACL to be applied on the resource. An admin may comes with its own access token, but it will only contains its own id. It has no way to pass the required user id as a parameter."),s("br"),e._v("\nYou would have to create a specific endpoint for the admin use case. It would be a shame, since being reusable for different clients is what APIs are all about.")]),e._v(" "),s("p",[s("strong",[e._v("Flaw 2:")]),e._v(" To improve my API performances, I would like to add some cache on top of it, for example using a CDN and the proper cache-control headers.")]),e._v(" "),s("p",[s("em",[e._v("Can't do:")]),e._v(" All the user profiles are retrieved under the same request, except for the access token. The cache service will not be able to distinguish them (unless you store the access token itself in the cache key, but you certainly don't want to do that!)")]),e._v(" "),s("p",[s("strong",[e._v("Flaw 3:")]),e._v(" This design is not affordant for a developer used to a classic REST design."),s("br"),e._v("\nLooking at the "),s("code",[e._v("GET /profile")]),e._v(" resource, I expect the response to be always the same, as there is no clue indicating that the response depends on the access token. I would have to go through the doc to understand that.")]),e._v(" "),s("p",[e._v("Having these limits in mind, what can we do?")]),e._v(" "),s("h3",{attrs:{id:"option-1-require-explicit-business-parameters"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#option-1-require-explicit-business-parameters"}},[e._v("#")]),e._v(" Option 1: require explicit business parameters")]),e._v(" "),s("p",[e._v("All the previous flaws are caused because the "),s("code",[e._v("user id")]),e._v(" is passed through the access token, even though it is a business parameter (the response content depends on it).")]),e._v(" "),s("p",[e._v("The simplest solution is to explicitly require all your business parameters, like for any other resource:"),s("br"),e._v("\nFor example, using "),s("code",[e._v("GET /profiles/:userId")])]),e._v(" "),s("div",{staticClass:"language-shell extra-class"},[s("pre",{pre:!0,attrs:{class:"language-shell"}},[s("code",[s("span",{pre:!0,attrs:{class:"token function"}},[e._v("curl")]),e._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("\\")]),e._v("\n-H "),s("span",{pre:!0,attrs:{class:"token string"}},[e._v('"Authorization: Bearer <alice_access_token>"')]),e._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("\\")]),e._v("\nhttps://api.example.com/v1/profiles/12345\n")])])]),s("div",{staticClass:"language-json extra-class"},[s("pre",{pre:!0,attrs:{class:"language-json"}},[s("code",[s("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("{")]),e._v("\n  "),s("span",{pre:!0,attrs:{class:"token property"}},[e._v('"id"')]),s("span",{pre:!0,attrs:{class:"token operator"}},[e._v(":")]),e._v(" "),s("span",{pre:!0,attrs:{class:"token number"}},[e._v("12345")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(",")]),e._v("\n  "),s("span",{pre:!0,attrs:{class:"token property"}},[e._v('"username"')]),s("span",{pre:!0,attrs:{class:"token operator"}},[e._v(":")]),e._v(" "),s("span",{pre:!0,attrs:{class:"token string"}},[e._v('"Alice"')]),e._v("\n"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("}")]),e._v("\n")])])]),s("p",[e._v("So that you separate concerns:")]),e._v(" "),s("ul",[s("li",[e._v("when the response of your endpoint depends on business parameters, they are explicitly requested in path parameters, query string or request body.")]),e._v(" "),s("li",[e._v("when the right to access to your resource depends on the ACL of the user, they are enforced using the access token.")])]),e._v(" "),s("p",[e._v("Constraints:")]),e._v(" "),s("ul",[s("li",[e._v("for the API Client: extract the user id from the access token or the id token (generally in the "),s("code",[e._v("sub")]),e._v(" claim). But in most contexts, user id should be an information already known by the frontend.")]),e._v(" "),s("li",[e._v("for the API: we now have to check that the authenticated user can access the requested operation (as it was implicit with the previous design)")])]),e._v(" "),s("h3",{attrs:{id:"option-2-show-explicitly-that-the-access-token-is-used-as-a-parameter"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#option-2-show-explicitly-that-the-access-token-is-used-as-a-parameter"}},[e._v("#")]),e._v(" Option 2: show explicitly that the access token is used as a parameter")]),e._v(" "),s("p",[e._v("You may think that your API design is dedicated to a single frontend use, and not be afraid by the previous flaws.")]),e._v(" "),s("p",[e._v("In this case, it can makes sense to favour a flawless usage for your frontend, and offer a simpler way to access some of the authenticated user information.")]),e._v(" "),s("p",[e._v("But if you want do go this way, we strongly suggest to "),s("strong",[e._v("make it explicit in the endpoint naming")]),e._v(", to avoid at least the non-affordance flaw.")]),e._v(" "),s("p",[e._v("A common way to expose such an endpoint is to use "),s("code",[e._v("/me")]),e._v(" or "),s("code",[e._v("/@me")]),e._v(" in the endpoint. A developer will be able to understand that this endpoint is about the authenticated user:")]),e._v(" "),s("ul",[s("li",[s("code",[e._v("GET /profile/@me")])]),e._v(" "),s("li",[s("code",[e._v("GET /users/@me/profile")])]),e._v(" "),s("li",[s("code",[e._v("GET /@me")]),e._v(" as a shortcut for the user profile")]),e._v(" "),s("li",[s("code",[e._v("GET /@me/orders")]),e._v(" for the orders of the authenticated user")]),e._v(" "),s("li",[e._v("...")])]),e._v(" "),s("p",[e._v("An example "),s("a",{attrs:{href:"https://developer.spotify.com/documentation/web-api/reference/#category-library",target:"_blank",rel:"noopener noreferrer"}},[e._v("on Spotify API"),s("OutboundLink")],1),e._v(":"),s("br"),e._v(" "),s("code",[e._v("GET https://api.spotify.com/v1/me/albums")]),e._v(" : get the albums of the authenticated user.")]),e._v(" "),s("p",[e._v("Here is a request with Alice access token, retrieving Alice's profile:")]),e._v(" "),s("div",{staticClass:"language-shell extra-class"},[s("pre",{pre:!0,attrs:{class:"language-shell"}},[s("code",[s("span",{pre:!0,attrs:{class:"token function"}},[e._v("curl")]),e._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("\\")]),e._v("\n-H "),s("span",{pre:!0,attrs:{class:"token string"}},[e._v('"Authorization: Bearer <alice_access_token>"')]),e._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("\\")]),e._v("\nhttps://api.example.com/v1/profile/@me\n")])])]),s("div",{staticClass:"language-json extra-class"},[s("pre",{pre:!0,attrs:{class:"language-json"}},[s("code",[s("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("{")]),e._v("\n  "),s("span",{pre:!0,attrs:{class:"token property"}},[e._v('"id"')]),s("span",{pre:!0,attrs:{class:"token operator"}},[e._v(":")]),e._v(" "),s("span",{pre:!0,attrs:{class:"token number"}},[e._v("12345")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(",")]),e._v("\n  "),s("span",{pre:!0,attrs:{class:"token property"}},[e._v('"username"')]),s("span",{pre:!0,attrs:{class:"token operator"}},[e._v(":")]),e._v(" "),s("span",{pre:!0,attrs:{class:"token string"}},[e._v('"Alice"')]),e._v("\n"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("}")]),e._v("\n")])])]),s("p",[e._v("Here is a request with Bob access token, retrieving Bob's profile:")]),e._v(" "),s("div",{staticClass:"language-shell extra-class"},[s("pre",{pre:!0,attrs:{class:"language-shell"}},[s("code",[s("span",{pre:!0,attrs:{class:"token function"}},[e._v("curl")]),e._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("\\")]),e._v("\n-H "),s("span",{pre:!0,attrs:{class:"token string"}},[e._v('"Authorization: Bearer <bob_access_token>"')]),e._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("\\")]),e._v("\nhttps://api.example.com/v1/profile/@me\n")])])]),s("div",{staticClass:"language-json extra-class"},[s("pre",{pre:!0,attrs:{class:"language-json"}},[s("code",[s("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("{")]),e._v("\n  "),s("span",{pre:!0,attrs:{class:"token property"}},[e._v('"id"')]),s("span",{pre:!0,attrs:{class:"token operator"}},[e._v(":")]),e._v(" "),s("span",{pre:!0,attrs:{class:"token number"}},[e._v("67890")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(",")]),e._v("\n  "),s("span",{pre:!0,attrs:{class:"token property"}},[e._v('"username"')]),s("span",{pre:!0,attrs:{class:"token operator"}},[e._v(":")]),e._v(" "),s("span",{pre:!0,attrs:{class:"token string"}},[e._v('"Bob"')]),e._v("\n"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("}")]),e._v("\n")])])]),s("p",[e._v("In a nutshell:")]),e._v(" "),s("ul",[s("li",[e._v("This may be a legitimate use case if your API is dedicated to a frontend.")]),e._v(" "),s("li",[e._v("Be aware that this design jeopardize the reuse of your API, and forbid any caching feature.")]),e._v(" "),s("li",[e._v("This should be limited to a few simple endpoints: having this design on your complete API would be a huge smell!")])])])}),[],!1,null,null,null);t.default=n.exports}}]);