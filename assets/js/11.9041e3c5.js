(window.webpackJsonp=window.webpackJsonp||[]).push([[11],{389:function(e,t,s){"use strict";s.r(t);var a=s(42),r=Object(a.a)({},(function(){var e=this,t=e.$createElement,s=e._self._c||t;return s("ContentSlotsDistributor",{attrs:{"slot-key":e.$parent.slotKey}},[s("h1",{attrs:{id:"design-asynchronous-api"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#design-asynchronous-api"}},[e._v("#")]),e._v(" Design asynchronous API")]),e._v(" "),s("h2",{attrs:{id:"use-case"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#use-case"}},[e._v("#")]),e._v(" Use-case")]),e._v(" "),s("p",[e._v("My e-commerce API allows me to download a PDF export of my orders."),s("br"),e._v("\nThis operation searches for eligible orders, formats the data and generates the PDF file.\nAll these operations put together can take seconds.")]),e._v(" "),s("p",[e._v("It is inappropriate to expose a synchronous API on this use-case for these reasons:")]),e._v(" "),s("ul",[s("li",[e._v("The user experience is strongly degraded with a response time of several seconds;")]),e._v(" "),s("li",[e._v("504 timeout errors may occur depending on the processing time and/or the HTTP proxy servers' configuration;")]),e._v(" "),s("li",[e._v('The application can become "overloaded" if too many exports are requested in the same time frame.')])]),e._v(" "),s("h2",{attrs:{id:"how-to-design-my-api"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#how-to-design-my-api"}},[e._v("#")]),e._v(" How to design my API ?")]),e._v(" "),s("p",[e._v('We recommend adopting an "asynchronous" API design to resolve these issues.'),s("br"),e._v("\nTwo architecture's points has to be setting up:")]),e._v(" "),s("ul",[s("li",[e._v("Expose a REST API to "),s("strong",[e._v("retrieve the user's request")]),e._v(", in our case, its PDF export request")]),e._v(" "),s("li",[s("strong",[e._v("Dissociate heavy HTTP traffic from processing if necessary")]),e._v(". This processing can be triggered via cronjob, queuing for example.")])]),e._v(" "),s("p",[e._v("Now we have to manage the problem of notifying the User with the job progress.\nTwo API designs are possible for this problem.")]),e._v(" "),s("h2",{attrs:{id:"recipe-1-async-api-with-polling"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#recipe-1-async-api-with-polling"}},[e._v("#")]),e._v(" Recipe 1: Async API with polling")]),e._v(" "),s("p",[e._v("Polling is the easiest solution to implement."),s("br"),e._v("\nIt has several benefits:")]),e._v(" "),s("ul",[s("li",[e._v("delegate to the client the resource's creation tracking;")]),e._v(" "),s("li",[e._v("to not expose a callback endpoint for the client.")])]),e._v(" "),s("p",[e._v("Polling technique consists of 3 main steps for the client:")]),e._v(" "),s("ul",[s("li",[e._v("requesting the resource;")]),e._v(" "),s("li",[e._v("verifying the job progress;")]),e._v(" "),s("li",[e._v("obtaining the created resource.")])]),e._v(" "),s("h3",{attrs:{id:"requesting-the-resource"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#requesting-the-resource"}},[e._v("#")]),e._v(" Requesting the resource")]),e._v(" "),s("p",[e._v("The client sends an HTTP request to the asynchronous endpoint with the necessary information:")]),e._v(" "),s("div",{staticClass:"language-shell extra-class"},[s("pre",{pre:!0,attrs:{class:"language-shell"}},[s("code",[s("span",{pre:!0,attrs:{class:"token function"}},[e._v("curl")]),e._v(" -X POST https://api.example.com/v1/orders/reports\n")])])]),s("div",{staticClass:"language-json extra-class"},[s("pre",{pre:!0,attrs:{class:"language-json"}},[s("code",[s("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("{")]),e._v("\n  "),s("span",{pre:!0,attrs:{class:"token property"}},[e._v('"start_date"')]),s("span",{pre:!0,attrs:{class:"token operator"}},[e._v(":")]),e._v(" "),s("span",{pre:!0,attrs:{class:"token string"}},[e._v('"2021-10-01"')]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(",")]),e._v("\n  "),s("span",{pre:!0,attrs:{class:"token property"}},[e._v('"end_date"')]),s("span",{pre:!0,attrs:{class:"token operator"}},[e._v(":")]),e._v(" "),s("span",{pre:!0,attrs:{class:"token string"}},[e._v('"2021-11-01"')]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(",")]),e._v("\n  ...\n"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("}")]),e._v("\n")])])]),s("p",[e._v("APIs response :")]),e._v(" "),s("div",{staticClass:"language-shell extra-class"},[s("pre",{pre:!0,attrs:{class:"language-shell"}},[s("code",[e._v("HTTP/1.1 "),s("span",{pre:!0,attrs:{class:"token number"}},[e._v("202")]),e._v(" Accepted\nLocation: orders/report/status/99311702-cdaa-4069-85da-ea74a46035e6\nRetry-After: "),s("span",{pre:!0,attrs:{class:"token number"}},[e._v("60")]),e._v("\n")])])]),s("p",[e._v("Some information are relevant in this answer:")]),e._v(" "),s("ul",[s("li",[e._v("Header "),s("a",{attrs:{href:"https://developer.mozilla.org/en-US/docs/Web/HTTP/Headers/Location",target:"_blank",rel:"noopener noreferrer"}},[e._v("Location"),s("OutboundLink")],1),e._v(" contains the URI that permits\nto follow asynchronous proceeding's progress")]),e._v(" "),s("li",[e._v("Status code "),s("a",{attrs:{href:"https://developer.mozilla.org/en-US/docs/Web/HTTP/Status/202",target:"_blank",rel:"noopener noreferrer"}},[e._v("HTTP 202"),s("OutboundLink")],1),e._v(" indicates that,\nthe request has been taken into account but that processing did not occur.")]),e._v(" "),s("li",[e._v("Finally, we advise you to add the header "),s("a",{attrs:{href:"https://developer.mozilla.org/en-US/docs/Web/HTTP/Headers/Retry-After",target:"_blank",rel:"noopener noreferrer"}},[e._v("Retry-After"),s("OutboundLink")],1),e._v("\ninforming the client how long to wait before calling the endpoint again. This value can be linked to a cache policy for example.")])]),e._v(" "),s("h3",{attrs:{id:"checking-the-progress"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#checking-the-progress"}},[e._v("#")]),e._v(" Checking the progress")]),e._v(" "),s("p",[e._v("Now, the client is free to consult this URL as many times as necessary to follow the progress of the asynchronous processing."),s("br"),e._v("\nIt is important to "),s("strong",[e._v("protect APIs with a rate-limiting system")]),e._v(" preventing clients from abuse of your endpoint and by extension, crash your app.")]),e._v(" "),s("div",{staticClass:"language-shell extra-class"},[s("pre",{pre:!0,attrs:{class:"language-shell"}},[s("code",[s("span",{pre:!0,attrs:{class:"token function"}},[e._v("curl")]),e._v(" -X GET https://api.example.com/v1/orders/reports/status/99311702-cdaa-4069-85da-ea74a46035e6\n")])])]),s("p",[e._v("APIs response :")]),e._v(" "),s("div",{staticClass:"language-shell extra-class"},[s("pre",{pre:!0,attrs:{class:"language-shell"}},[s("code",[e._v("HTTP/1.1 "),s("span",{pre:!0,attrs:{class:"token number"}},[e._v("200")]),e._v(" OK\nContent-Type: application/json\nRetry-After: "),s("span",{pre:!0,attrs:{class:"token number"}},[e._v("60")]),e._v("\n")])])]),s("div",{staticClass:"language-json extra-class"},[s("pre",{pre:!0,attrs:{class:"language-json"}},[s("code",[s("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("{")]),e._v("\n "),s("span",{pre:!0,attrs:{class:"token property"}},[e._v('"status"')]),e._v(" "),s("span",{pre:!0,attrs:{class:"token operator"}},[e._v(":")]),e._v(" "),s("span",{pre:!0,attrs:{class:"token string"}},[e._v('"IN_PROGRESS"')]),e._v("\n"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("}")]),e._v("\n")])])]),s("p",[e._v("If an error occurs during the asynchronous process, return a payload containing an error code and a message.\nFor more information, you can check the "),s("RouterLink",{attrs:{to:"/error-format.html"}},[e._v("error format")]),e._v(" recipe.")],1),e._v(" "),s("h3",{attrs:{id:"obtaining-a-resource"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#obtaining-a-resource"}},[e._v("#")]),e._v(" Obtaining a resource")]),e._v(" "),s("p",[e._v("Once the processing is successfully completed on the server side, status's endpoint "),s("strong",[e._v("must return an HTTP 303 code")]),e._v(" indicating the URI of the new created resource (our pdf in this scenario) :")]),e._v(" "),s("div",{staticClass:"language-shell extra-class"},[s("pre",{pre:!0,attrs:{class:"language-shell"}},[s("code",[s("span",{pre:!0,attrs:{class:"token function"}},[e._v("curl")]),e._v(" -X GET https://api.example.com/v1/orders/reports/status/99311702-cdaa-4069-85da-ea74a46035e6\n")])])]),s("p",[e._v("APIs response:")]),e._v(" "),s("div",{staticClass:"language-shell extra-class"},[s("pre",{pre:!0,attrs:{class:"language-shell"}},[s("code",[e._v("HTTP/1.1 "),s("span",{pre:!0,attrs:{class:"token number"}},[e._v("303")]),e._v(" See Other\nLocation "),s("span",{pre:!0,attrs:{class:"token builtin class-name"}},[e._v(":")]),e._v(" api/orders/reports/99311702-cdaa-4069-85da-ea74a46035e6\n")])])]),s("p",[e._v("For more information on the code "),s("a",{attrs:{href:"https://developer.mozilla.org/en-US/docs/Web/HTTP/Status/303",target:"_blank",rel:"noopener noreferrer"}},[e._v("HTTP 303"),s("OutboundLink")],1)]),e._v(" "),s("h3",{attrs:{id:"drawbacks"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#drawbacks"}},[e._v("#")]),e._v(" Drawbacks")]),e._v(" "),s("p",[e._v("The main disadvantages of this technique can be found in :")]),e._v(" "),s("ul",[s("li",[e._v("Additional development for the progress mechanism API;")]),e._v(" "),s("li",[e._v("An overload of the system and a waste of energy induced by the client-side pulling mechanism.")])]),e._v(" "),s("h3",{attrs:{id:"don-t"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#don-t"}},[e._v("#")]),e._v(" Don't")]),e._v(" "),s("p",[e._v("Do not tell your clients to use the GET route of your resource (example: "),s("code",[e._v("GET api/orders/reports/{id}")]),e._v(") to track resource creation.")]),e._v(" "),s("p",[e._v("Clients will not be able to distinguish if the resource does not exist because the processing has not finished or if an error has occurred.")]),e._v(" "),s("h2",{attrs:{id:"recipe-2-async-api-with-a-callback-url"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#recipe-2-async-api-with-a-callback-url"}},[e._v("#")]),e._v(" Recipe 2: Async API with a callback URL")]),e._v(" "),s("p",[e._v("The most complex solution to implement.")]),e._v(" "),s("p",[e._v("This design is divided into 2 main steps:")]),e._v(" "),s("ul",[s("li",[e._v("request of the resource by the client;")]),e._v(" "),s("li",[e._v("notification from the server to the client that job has ended.")])]),e._v(" "),s("p",[e._v("It has several benefits:")]),e._v(" "),s("ul",[s("li",[e._v("efficiency of the scenario, the server informs the client of the end of processing;")]),e._v(" "),s("li",[e._v("no development of a progress monitoring endpoint on server-side.")])]),e._v(" "),s("h3",{attrs:{id:"requesting-the-resource-2"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#requesting-the-resource-2"}},[e._v("#")]),e._v(" Requesting the resource")]),e._v(" "),s("p",[e._v("The client sends an HTTP request to the asynchronous endpoint with the necessary information as in the polling case.\n"),s("strong",[e._v("In this scenario, the client will have to provide in addition, a callback url")]),e._v(". This url is going to be "),s("strong",[e._v("stored on server side")]),e._v(" and "),s("strong",[e._v("called by this last one")]),e._v(" once the treatment is complete.")]),e._v(" "),s("div",{staticClass:"language-shell extra-class"},[s("pre",{pre:!0,attrs:{class:"language-shell"}},[s("code",[s("span",{pre:!0,attrs:{class:"token function"}},[e._v("curl")]),e._v(" -X POST https://api.example.com/v1/orders/reports\n")])])]),s("div",{staticClass:"language-json extra-class"},[s("pre",{pre:!0,attrs:{class:"language-json"}},[s("code",[s("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("{")]),e._v("\n  "),s("span",{pre:!0,attrs:{class:"token property"}},[e._v('"start_date"')]),e._v(" "),s("span",{pre:!0,attrs:{class:"token operator"}},[e._v(":")]),s("span",{pre:!0,attrs:{class:"token string"}},[e._v('"2021-10-01"')]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(",")]),e._v("\n  "),s("span",{pre:!0,attrs:{class:"token property"}},[e._v('"end_date"')]),e._v(" "),s("span",{pre:!0,attrs:{class:"token operator"}},[e._v(":")]),e._v(" "),s("span",{pre:!0,attrs:{class:"token string"}},[e._v('"2021-11-01"')]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(",")]),e._v("\n  "),s("span",{pre:!0,attrs:{class:"token property"}},[e._v('"callback_url"')]),e._v(" "),s("span",{pre:!0,attrs:{class:"token operator"}},[e._v(":")]),e._v(" "),s("span",{pre:!0,attrs:{class:"token string"}},[e._v('"http://myserver.com/api/orders/reports/callback"')]),e._v("\n"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("}")]),e._v("\n")])])]),s("p",[e._v("APIs response:")]),e._v(" "),s("div",{staticClass:"language-shell extra-class"},[s("pre",{pre:!0,attrs:{class:"language-shell"}},[s("code",[e._v("HTTP/1.1 "),s("span",{pre:!0,attrs:{class:"token number"}},[e._v("202")]),e._v(" Accepted\n")])])]),s("h3",{attrs:{id:"notifying-the-client"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#notifying-the-client"}},[e._v("#")]),e._v(" Notifying the client")]),e._v(" "),s("p",[e._v("Once the asynchronous processing is completed, the server will make a POST call to the client to "),s("strong",[e._v("notifying the end of the job")]),e._v(". "),s("br"),e._v("\nWe recommend that the payload contains the status of the treatment and a link to the created resource.")]),e._v(" "),s("div",{staticClass:"language-shell extra-class"},[s("pre",{pre:!0,attrs:{class:"language-shell"}},[s("code",[s("span",{pre:!0,attrs:{class:"token function"}},[e._v("curl")]),e._v(" -X POST http://myserver.com/api/orders/reports/callback\n")])])]),s("div",{staticClass:"language-json extra-class"},[s("pre",{pre:!0,attrs:{class:"language-json"}},[s("code",[s("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("{")]),e._v("\n  "),s("span",{pre:!0,attrs:{class:"token property"}},[e._v('"status"')]),e._v(" "),s("span",{pre:!0,attrs:{class:"token operator"}},[e._v(":")]),e._v(" "),s("span",{pre:!0,attrs:{class:"token string"}},[e._v('"COMPLETED"')]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(",")]),e._v("\n  "),s("span",{pre:!0,attrs:{class:"token property"}},[e._v('"links"')]),e._v(" "),s("span",{pre:!0,attrs:{class:"token operator"}},[e._v(":")]),e._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("[")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("{")]),e._v("\n    "),s("span",{pre:!0,attrs:{class:"token property"}},[e._v('"rel"')]),e._v(" "),s("span",{pre:!0,attrs:{class:"token operator"}},[e._v(":")]),e._v(" "),s("span",{pre:!0,attrs:{class:"token string"}},[e._v('"reports"')]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(",")]),e._v("\n    "),s("span",{pre:!0,attrs:{class:"token property"}},[e._v('"href"')]),e._v(" "),s("span",{pre:!0,attrs:{class:"token operator"}},[e._v(":")]),e._v(" "),s("span",{pre:!0,attrs:{class:"token string"}},[e._v('"orders/reports/0a6509c6-1571-48be-b177-95a7d640e04f"')]),e._v("\n  "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("}")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("]")]),e._v("\n"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("}")]),e._v("\n")])])]),s("p",[e._v("The client can now retrieve its resource by performing a GET call.")]),e._v(" "),s("h3",{attrs:{id:"drawbacks-2"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#drawbacks-2"}},[e._v("#")]),e._v(" Drawbacks")]),e._v(" "),s("p",[e._v("This solution has several constraints:")]),e._v(" "),s("ul",[s("li",[e._v("it "),s("strong",[e._v("can only be used in server-to-server exchanges")]),e._v(";")]),e._v(" "),s("li",[e._v("it requires more "),s("strong",[e._v("client-side development")]),e._v(" to expose a callback endpoint;")]),e._v(" "),s("li",[s("strong",[e._v("The need to manage the potential unavailability of the client.")]),e._v(" A first answer would be to set up a retry mechanism.")]),e._v(" "),s("li",[s("strong",[e._v("The need to manage the mutual authentication of the client and the server.")]),s("br"),e._v("\nSince both endpoints ("),s("code",[e._v("/reports")]),e._v(" on the server side and "),s("code",[e._v("/callback")]),e._v(" on the client side) are exposed, both parties must ensure the identity of each-other.")])])])}),[],!1,null,null,null);t.default=r.exports}}]);